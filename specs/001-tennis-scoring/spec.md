# 功能規格：網球單局計分系統

**功能分支**: `001-tennis-scoring`
**建立日期**: 2025-11-18
**狀態**: Draft
**輸入**: 使用者描述：「建立一個單一 Game 的計分 Library（TennisScoring），負責根據 A/B 球員的得分，輸出正確的文字比分描述。」

## Clarifications

### Session 2025-11-18

- Q: 當某球員已獲勝（Win 狀態）後，若再次呼叫 PointWonBy() 記錄得分，系統應該如何行為？ → A: 拋出例外（如 InvalidOperationException），明確告知呼叫端比賽已結束
- Q: Advantage 和 Win 狀態的比分文字格式，應該如何標識球員？ → A: 使用「PlayerA Adv」/「PlayerB Win」格式（純英文，與 Side enum 一致）
- Q: 系統是否需要支援以任意得分狀態初始化比賽？ → A: 僅支援 0-0 起始，建構函式不接受初始分數參數（符合實際網球比賽規則，簡化設計）

## 使用者情境與測試 *(必填)*

### 使用者故事 1 - 基本得分顯示（0-3分） (優先順序: P1)

作為一位網球比賽計分員，我需要系統能夠正確顯示雙方球員在 0 到 3 分範圍內的比分文字描述（Love、Fifteen、Thirty、Forty），以便我能快速了解當前局面。

**為何設定此優先順序**: 這是網球計分的基礎功能，涵蓋了大部分常見比分情況（平分與非平分狀態），是系統的核心價值所在。沒有這個功能，整個計分系統無法運作。

**獨立測試**: 可以透過輸入 A/B 球員各自 0-3 分的得分組合，驗證系統輸出正確的文字描述（如 Love-All、Fifteen-Love、Thirty-All、Forty-Love 等），並能獨立展示基本計分能力。

**驗收情境**:

1. **Given** 一局新的網球比賽開始，**When** A 球員未得分且 B 球員未得分，**Then** 顯示的比分文字應該是「Love-All」
2. **Given** 一局新的網球比賽開始，**When** A 球員得 1 分且 B 球員未得分，**Then** 顯示的比分文字應該是「Fifteen-Love」
3. **Given** 一局新的網球比賽開始，**When** A 球員得 2 分且 B 球員未得分，**Then** 顯示的比分文字應該是「Thirty-Love」
4. **Given** 一局新的網球比賽開始，**When** A 球員得 3 分且 B 球員未得分，**Then** 顯示的比分文字應該是「Forty-Love」
5. **Given** 一局新的網球比賽開始，**When** A 球員未得分且 B 球員得 1 分，**Then** 顯示的比分文字應該是「Love-Fifteen」
6. **Given** 一局新的網球比賽開始，**When** A 球員未得分且 B 球員得 2 分，**Then** 顯示的比分文字應該是「Love-Thirty」
7. **Given** 一局新的網球比賽開始，**When** A 球員未得分且 B 球員得 3 分，**Then** 顯示的比分文字應該是「Love-Forty」
8. **Given** 一局新的網球比賽開始，**When** A 球員得 1 分且 B 球員得 1 分，**Then** 顯示的比分文字應該是「Fifteen-All」
9. **Given** 一局新的網球比賽開始，**When** A 球員得 2 分且 B 球員得 2 分，**Then** 顯示的比分文字應該是「Thirty-All」

---

### 使用者故事 2 - Deuce 狀態處理 (優先順序: P2)

作為一位網球比賽計分員，當雙方球員都達到 40 分（3 分或以上且平手）時，我需要系統顯示「Deuce」，以便正確呈現平手的膠著狀態。

**為何設定此優先順序**: Deuce 是網球規則中的重要特殊狀態，代表雙方實力相當。雖然不如基本計分頻繁，但對於完整性和正確性至關重要。

**獨立測試**: 可以透過讓雙方球員都達到 3 分或更高且分數相同的情況，驗證系統輸出「Deuce」，並能獨立展示平手處理邏輯。

**驗收情境**:

1. **Given** 一局新的網球比賽開始，**When** A 球員得 3 分且 B 球員得 3 分，**Then** 顯示的比分文字應該是「Deuce」
2. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 4 分，**Then** 顯示的比分文字應該是「Deuce」
3. **Given** 一局新的網球比賽開始，**When** A 球員得 5 分且 B 球員得 5 分，**Then** 顯示的比分文字應該是「Deuce」

---

### 使用者故事 3 - Advantage 狀態處理 (優先順序: P3)

作為一位網球比賽計分員，當 Deuce 狀態後某一方球員領先 1 分時，我需要系統顯示該球員的 Advantage 狀態（如「PlayerA Adv」或「PlayerB Adv」），以便清楚呈現誰擁有優勢。

**為何設定此優先順序**: Advantage 是 Deuce 狀態的延伸，發生頻率較低，但對於完整比賽邏輯不可或缺。

**獨立測試**: 可以透過在 Deuce 狀態後讓某一方多得 1 分，驗證系統輸出正確的 Advantage 文字，並能獨立展示優勢判斷邏輯。

**驗收情境**:

1. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 3 分，**Then** 顯示的比分文字應該是「PlayerA Adv」
2. **Given** 一局新的網球比賽開始，**When** A 球員得 3 分且 B 球員得 4 分，**Then** 顯示的比分文字應該是「PlayerB Adv」
3. **Given** 一局新的網球比賽開始，**When** A 球員得 5 分且 B 球員得 4 分，**Then** 顯示的比分文字應該是「PlayerA Adv」
4. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 5 分，**Then** 顯示的比分文字應該是「PlayerB Adv」

---

### 使用者故事 4 - 獲勝判定 (優先順序: P4)

作為一位網球比賽計分員，當某一方球員在領先 2 分或以上（且至少 4 分）的情況下，我需要系統顯示該球員獲勝（如「PlayerA Win」或「PlayerB Win」），以便宣告該局結束。

**為何設定此優先順序**: 獲勝判定是比賽的最終狀態，雖然重要但依賴於前面所有計分邏輯的正確性，因此優先順序較低。

**獨立測試**: 可以透過讓某一方球員在 Deuce/Advantage 狀態後領先 2 分，或在基本計分階段達到 4 分且對手未超過 2 分，驗證系統輸出獲勝訊息。

**驗收情境**:

1. **Given** 一局新的網球比賽開始，**When** A 球員得 5 分且 B 球員得 3 分，**Then** 顯示的比分文字應該是「PlayerA Win」
2. **Given** 一局新的網球比賽開始，**When** A 球員得 3 分且 B 球員得 5 分，**Then** 顯示的比分文字應該是「PlayerB Win」
3. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 0 分，**Then** 顯示的比分文字應該是「PlayerA Win」
4. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 1 分，**Then** 顯示的比分文字應該是「PlayerA Win」
5. **Given** 一局新的網球比賽開始，**When** A 球員得 4 分且 B 球員得 2 分，**Then** 顯示的比分文字應該是「PlayerA Win」

---

### 邊界情況

- 當某一方球員得分超過 10 分時，系統持續套用 Deuce/Advantage/Win 規則（無上限，直到有球員領先 2 分獲勝）
- 當嘗試在比賽已結束（某方獲勝）後繼續記錄得分時，系統必須拋出 InvalidOperationException，明確告知呼叫端比賽已結束，防止進入無效狀態

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須能夠追蹤單一網球局（Game）中 A 球員和 B 球員的得分狀態
- **FR-002**: 系統必須能夠根據球員得分次數，將數字分數映射為網球術語（0→Love, 1→Fifteen, 2→Thirty, 3→Forty）
- **FR-003**: 系統必須在雙方球員分數相同時，根據分數值顯示適當的平分文字：
  - 0-0, 1-1, 2-2 顯示為「[分數]-All」（如 Love-All, Fifteen-All, Thirty-All）
  - 3-3 及以上顯示為「Deuce」
- **FR-004**: 系統必須在雙方球員分數不同時，顯示「[A分數]-[B分數]」格式的文字（如 Fifteen-Love, Thirty-Fifteen）
- **FR-005**: 系統必須在雙方球員都達到 3 分以上且分數差距為 1 分時，顯示領先球員的 Advantage 狀態（格式為「PlayerA Adv」或「PlayerB Adv」）
- **FR-006**: 系統必須在以下情況判定某球員獲勝並顯示「PlayerA Win」或「PlayerB Win」：
  - 該球員至少得 4 分，且領先對手至少 2 分
- **FR-007**: 系統必須提供記錄球員得分的介面（如 `PointWonBy(Side side)` 方法）
- **FR-008**: 系統必須提供查詢當前比分文字的介面（如 `GetScoreText()` 方法）
- **FR-009**: 系統必須支援重新開始新局（重置雙方分數為 0）
- **FR-010**: 系統必須在比賽已結束（某球員獲勝）後，拋出 InvalidOperationException 當嘗試記錄新得分時，確保 Game 物件狀態的不變性
- **FR-011**: 系統初始化時必須將雙方球員分數設定為 0（Love-All），不接受任意起始分數參數

### 關鍵實體

- **Game（局）**: 代表一場網球的單一局比賽，包含 A 球員和 B 球員的當前得分、比賽狀態（進行中/已結束）以及獲勝者資訊（如適用）。
- **Side（球員方）**: 列舉類型，用於標識球員（PlayerA 或 PlayerB）。
- **ScoreMapping（分數映射）**: 將數字分數（0, 1, 2, 3）映射為網球術語（Love, Fifteen, Thirty, Forty）的邏輯規則。

## 成功標準 *(必填)*

### 可衡量成果

- **SC-001**: 系統必須能夠在不到 10 毫秒內計算並返回當前比分文字（效能要求）
- **SC-002**: 系統必須通過所有 26 個驗收情境的測試案例（涵蓋基本計分、Deuce、Advantage、Win 四種使用者故事）
- **SC-003**: 系統必須在所有測試案例中輸出的比分文字與預期結果 100% 一致（正確性要求）
- **SC-004**: 系統程式碼覆蓋率必須達到 80% 以上，特別是計分邏輯的核心方法
- **SC-005**: 系統必須能夠處理至少 1000 次連續的得分記錄操作，而不產生錯誤或效能衰退
- **SC-006**: 開發團隊必須能在 5 分鐘內理解程式碼結構和計分邏輯（可讀性要求）

## 假設與依賴

### 假設

- 網球規則遵循標準國際網球總會（ITF）的單局計分規則
- 此階段不考慮 Set（盤）和 Match（場）的計分，僅處理單一 Game（局）
- 球員識別僅需使用簡單的 PlayerA 和 PlayerB 標籤，不需要姓名或其他個人資訊
- 系統不需要持久化儲存比賽狀態，僅需在記憶體中維護當前局的資料
- 比分文字輸出使用英文網球術語（Love, Fifteen, Thirty, Forty, Deuce, Adv, Win）
- 每場比賽總是從 Love-All (0-0) 開始，不支援從任意分數恢復比賽

### 依賴

- 無外部系統依賴
- 開發環境需支援 .NET Core 10 和 C# 12+
- 測試框架使用 xUnit 和 SpecFlow（支援 Gherkin 語法）

## 範圍界定

### 包含範圍

- 單一網球局（Game）的完整計分邏輯
- 基本分數（0-3）的文字映射
- Deuce 狀態判定
- Advantage 狀態判定
- 獲勝條件判定
- 支援 BDD 風格的 Gherkin 測試案例

### 不包含範圍

- Set（盤）和 Match（場）的計分功能（未來擴充）
- 多局比賽歷史記錄
- 球員個人資訊管理
- 圖形化使用者介面（GUI）
- 網路通訊或遠端計分同步
- 比賽影片或統計分析功能
